<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agents | Phantom Paradox</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23111' width='100' height='100' rx='8'/><text x='50' y='62' font-family='monospace' font-size='24' fill='%2300ff88' text-anchor='middle' font-weight='bold'>402</text></svg>">
  <!-- Leaflet.js for reliable maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0a0c0f;
      --card: #111418;
      --card-alt: #161a1f;
      --border: #22272e;
      --text: #e6e8eb;
      --dim: #6e7681;
      --green: #3fb950;
      --red: #f85149;
      --blue: #58a6ff;
      --orange: #d29922;
      --purple: #a371f7;
      --cyan: #39c5cf;
    }
    body {
      font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', Consolas, monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-size: 13px;
    }
    a { color: var(--cyan); text-decoration: none; }
    a:hover { text-decoration: underline; }
    
    /* Header */
    .header {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo {
      font-size: 18px;
      font-weight: bold;
      color: var(--green);
    }
    .badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
      background: var(--green);
      color: #000;
    }
    .header-right a {
      color: var(--dim);
      margin-left: 16px;
      font-size: 12px;
    }
    .header-right a:hover { color: var(--text); text-decoration: none; }
    
    /* Tabs */
    .tabs {
      display: flex;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }
    .tab {
      padding: 12px 24px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      color: var(--dim);
      border-bottom: 3px solid transparent;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--green); border-bottom-color: var(--green); }
    
    /* Main Layout */
    .main {
      display: grid;
      grid-template-columns: 1fr 320px;
      min-height: calc(100vh - 100px);
    }
    @media (max-width: 900px) {
      .main { grid-template-columns: 1fr; }
      .sidebar { display: none; }
    }
    @media (max-width: 600px) {
      .header { padding: 10px 12px; flex-wrap: wrap; gap: 8px; }
      .header-right { display: none; }
      .tabs { overflow-x: auto; }
      .tab { padding: 10px 14px; font-size: 11px; white-space: nowrap; }
      .map-container { min-height: 300px; }
      .map-header { flex-wrap: wrap; gap: 8px; padding: 10px; }
      .map-stats { font-size: 10px; gap: 10px; }
      .map-legend { padding: 8px; }
      .legend-item { font-size: 9px; }
      .jobs-grid { grid-template-columns: 1fr; padding: 12px; gap: 12px; }
      .job-card { padding: 14px; }
      .job-card-header { flex-wrap: wrap; gap: 6px; }
      .download-btn { padding: 10px 8px; font-size: 10px; }
    }
    
    /* Map Container */
    .map-container {
      background: var(--card);
      border-right: 1px solid var(--border);
      position: relative;
      min-height: 500px;
    }
    .map-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .map-title {
      font-size: 14px;
      font-weight: bold;
    }
    .map-stats {
      display: flex;
      gap: 20px;
      font-size: 12px;
    }
    .map-stat-value { color: var(--green); font-weight: bold; }
    
    /* World Map */
    .world-map {
      width: 100%;
      height: calc(100% - 50px);
      position: relative;
      overflow: hidden;
    }
    #mapContainer {
      width: 100%;
      height: 100%;
      background: var(--card-alt);
    }
    /* Dark theme for Leaflet */
    .leaflet-container { background: #111418 !important; }
    .leaflet-tile-pane { filter: grayscale(100%) invert(100%) contrast(0.9) brightness(0.4) sepia(0.1); }
    .leaflet-control-attribution { display: none; }
    .leaflet-control-zoom { display: none; }
    
    /* Agent Markers on Map */
    .agent-marker-you .marker-pulse {
      width: 16px;
      height: 16px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 0 0 0 rgba(255,255,255,0.7);
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.7); }
      70% { box-shadow: 0 0 0 12px rgba(255,255,255,0); }
      100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
    }
    .leaflet-popup-content-wrapper {
      background: var(--card);
      color: var(--text);
      border-radius: 4px;
    }
    .leaflet-popup-tip { background: var(--card); }
    
    /* Agent Markers */
    .agent-markers {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }
    .marker {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green);
      transform: translate(-50%, -50%);
      pointer-events: auto;
      cursor: pointer;
    }
    .marker::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      border: 1px solid var(--green);
      opacity: 0.5;
      animation: ping 2s infinite;
    }
    @keyframes ping {
      75%, 100% { transform: scale(2); opacity: 0; }
    }
    .marker.you {
      width: 12px;
      height: 12px;
      background: var(--cyan);
      border: 2px solid #fff;
      z-index: 100;
    }
    .marker.you::after { border-color: var(--cyan); }
    .marker.cap-1 { background: var(--green); }
    .marker.cap-2 { background: var(--cyan); }
    .marker.cap-3 { background: var(--blue); }
    .marker.cap-4 { background: var(--purple); }
    .marker.cap-5 { background: var(--orange); }
    
    /* Legend */
    .map-legend {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: var(--card);
      border: 1px solid var(--border);
      padding: 10px 14px;
      border-radius: 4px;
      font-size: 10px;
    }
    .legend-title {
      color: var(--dim);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
    }
    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    /* Sidebar */
    .sidebar {
      background: var(--card);
      display: flex;
      flex-direction: column;
    }
    .section {
      border-bottom: 1px solid var(--border);
      padding: 16px;
    }
    .section-title {
      font-size: 10px;
      color: var(--dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
    }
    .stat-row:last-child { border-bottom: none; }
    .stat-label { color: var(--dim); }
    .stat-value { font-weight: 500; }
    .stat-value.green { color: var(--green); }
    .stat-value.cyan { color: var(--cyan); }
    
    /* Agent List */
    .agent-list {
      flex: 1;
      overflow-y: auto;
      max-height: 300px;
    }
    .agent-item {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .agent-item:hover { background: var(--card-alt); }
    .agent-item.you { background: rgba(57, 197, 207, 0.1); border-left: 3px solid var(--cyan); }
    .agent-addr {
      font-size: 12px;
      color: var(--cyan);
      margin-bottom: 4px;
    }
    .agent-location {
      font-size: 10px;
      color: var(--dim);
    }
    .agent-metrics {
      display: flex;
      gap: 15px;
      margin-top: 6px;
      font-size: 10px;
    }
    .agent-metric span { color: var(--dim); }
    .agent-metric strong { color: var(--text); }
    .agent-metric strong.good { color: var(--green); }
    .agent-metric strong.warn { color: var(--orange); }
    
    /* Jobs */
    .job-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    .job-item:last-child { border-bottom: none; }
    .job-name { display: flex; align-items: center; gap: 8px; }
    .job-rate { color: var(--green); font-weight: 500; }
    .job-unit { color: var(--dim); font-size: 10px; }
    
    /* Connect Button */
    .connect-btn {
      padding: 10px 20px;
      background: var(--green);
      border: none;
      color: #000;
      font-family: inherit;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
    }
    .connect-btn:hover { opacity: 0.9; }
    .connect-btn.connected { background: var(--cyan); }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--dim);
    }
    .empty-state .icon { font-size: 48px; margin-bottom: 15px; }
    .empty-state .msg { margin-bottom: 10px; }
    
    /* Tab Content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Jobs Tab */
    .jobs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      padding: 20px;
    }
    .job-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 16px;
    }
    .job-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .job-card-title {
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .job-card-rate {
      font-size: 16px;
      color: var(--green);
      font-weight: bold;
    }
    .job-card-desc {
      color: var(--dim);
      font-size: 12px;
      margin-bottom: 10px;
    }
    .job-card-tech {
      font-size: 10px;
      color: var(--purple);
      background: rgba(163, 113, 247, 0.1);
      padding: 4px 8px;
      border-radius: 3px;
    }
    
    /* Download Buttons */
    .download-btn {
      display: inline-block;
      padding: 8px 12px;
      background: var(--card-alt);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 11px;
      text-decoration: none;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s;
    }
    .download-btn:hover {
      background: var(--green);
      border-color: var(--green);
      color: #000;
      text-decoration: none;
    }
    .download-btn.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: var(--card);
    }
    .download-btn.disabled:hover {
      background: var(--card);
      border-color: var(--border);
      color: var(--dim);
    }
    .download-btn.ready {
      background: linear-gradient(135deg, var(--green), #00aa66);
      border-color: var(--green);
      color: #000;
      font-weight: 600;
    }
    .download-btn.ready:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(0, 255, 136, 0.4);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <span class="logo" style="display: flex; align-items: center; gap: 8px;"><img src="../assets/null-logo-128.png" alt="NULL" style="width: 28px; height: 28px; border-radius: 4px;">AGENTS</span>
      <span class="badge" id="statusBadge">OFFLINE</span>
    </div>
    <div class="header-right">
      <a href="../index.html">‚Üê Paradox</a>
      <a href="sim.html">Live Sim</a>
      <button class="connect-btn" id="connectBtn">CONNECT WALLET</button>
    </div>
  </header>
  
  <div class="tabs">
    <div class="tab active" data-tab="map">üó∫Ô∏è Network Map</div>
    <div class="tab" data-tab="config">‚öôÔ∏è Config</div>
    <div class="tab" data-tab="live">‚ö° Live Jobs</div>
    <div class="tab" data-tab="score">üèÜ Scores</div>
    <div class="tab" data-tab="deploy">üì¶ Agent Shop</div>
  </div>
  
  <!-- MAP TAB -->
  <div class="tab-content active" id="tab-map">
    <div class="main">
      <div class="map-container">
        <div class="map-header">
          <span class="map-title">Global Agent Network</span>
          <div class="map-stats">
            <span><span class="map-stat-value" id="onlineCount">0</span> online</span>
            <span><span class="map-stat-value" id="regionCount">0</span> regions</span>
            <span><span class="map-stat-value" id="totalBw">0</span> Gbps</span>
          </div>
        </div>
        <div class="world-map">
          <div id="mapContainer"></div>
        </div>
        <div class="map-legend">
          <div class="legend-title">Capability Level</div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--green)"></div> Relay</div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--cyan)"></div> + Compute</div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--blue)"></div> + Verify</div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--purple)"></div> + Jury</div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--orange)"></div> Full Stack</div>
        </div>
      </div>
      
      <div class="sidebar">
        <div class="section">
          <div class="section-title">Your Agent</div>
          <div id="yourAgent">
            <div class="empty-state" style="padding: 20px;">
              <div style="font-size: 24px; margin-bottom: 10px;">üëÜ</div>
              <div>Click CONNECT WALLET</div>
              <div style="font-size: 10px;">to show your agent</div>
            </div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">Connected Agents</div>
          <div class="agent-list" id="agentList">
            <div class="empty-state" style="padding: 20px;">
              No other agents yet
            </div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">You Earn (SOL/USDC)</div>
          <div id="jobPricing">
            <div class="job-item"><span class="job-name">üîó Relay</span><span><span class="job-rate">0.06 SOL</span><span class="job-unit">/GB</span></span></div>
            <div class="job-item"><span class="job-name">üì∏ Enhance</span><span><span class="job-rate">0.0003 SOL</span><span class="job-unit">/img</span></span></div>
            <div class="job-item"><span class="job-name">üé§ Transcribe</span><span><span class="job-rate">0.0004 SOL</span><span class="job-unit">/min</span></span></div>
            <div class="job-item"><span class="job-name">üéÆ GPU</span><span><span class="job-rate">0.0025 SOL</span><span class="job-unit">/hr</span></span></div>
            <div class="job-item"><span class="job-name">‚úì Verify</span><span><span class="job-rate">0.0001 SOL</span><span class="job-unit">/batch</span></span></div>
          </div>
          <div style="margin-top:8px;font-size:9px;color:var(--dim);">~$150/SOL rate</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- CONFIG TAB -->
  <div class="tab-content" id="tab-config">
    <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
      
      <!-- Gear Test -->
      <div class="job-card" style="border-color: var(--cyan); margin-bottom: 20px;">
        <div class="section-title">üìä GEAR TEST</div>
        <div id="gearTestResults" style="display: none;">
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
            <div style="text-align: center; padding: 15px; background: var(--card-alt); border-radius: 6px;">
              <div style="font-size: 24px;">üíª</div>
              <div style="font-size: 20px; font-weight: bold; color: var(--green);" id="gearCpu">--</div>
              <div style="font-size: 10px; color: var(--dim);">CPU Cores</div>
            </div>
            <div style="text-align: center; padding: 15px; background: var(--card-alt); border-radius: 6px;">
              <div style="font-size: 24px;">üß†</div>
              <div style="font-size: 20px; font-weight: bold; color: var(--green);" id="gearRam">--</div>
              <div style="font-size: 10px; color: var(--dim);">RAM (GB)</div>
            </div>
            <div style="text-align: center; padding: 15px; background: var(--card-alt); border-radius: 6px;">
              <div style="font-size: 24px;">üì∂</div>
              <div style="font-size: 20px; font-weight: bold; color: var(--green);" id="gearSpeed">--</div>
              <div style="font-size: 10px; color: var(--dim);">Mbps</div>
            </div>
            <div style="text-align: center; padding: 15px; background: var(--card-alt); border-radius: 6px;">
              <div style="font-size: 24px;">‚è±Ô∏è</div>
              <div style="font-size: 20px; font-weight: bold; color: var(--green);" id="gearLatency">--</div>
              <div style="font-size: 10px; color: var(--dim);">Latency (ms)</div>
            </div>
          </div>
          <div style="font-size: 11px; color: var(--dim); padding: 10px; background: rgba(63, 185, 80, 0.1); border-radius: 4px;">
            üí° <strong>Suggested limits based on your hardware are pre-filled below</strong>
          </div>
        </div>
        <div id="gearTestPrompt">
          <div style="text-align: center; padding: 30px;">
            <div style="font-size: 48px; margin-bottom: 15px;">üî¨</div>
            <div style="margin-bottom: 15px;">Run a gear test to detect your hardware capabilities</div>
            <button onclick="runGearTest()" class="download-btn ready" style="padding: 12px 30px; font-size: 14px;">üöÄ Run Gear Test</button>
          </div>
        </div>
      </div>
      
      <!-- Resource Limits -->
      <div class="job-card" style="margin-bottom: 20px;">
        <div class="section-title">‚öôÔ∏è RESOURCE LIMITS</div>
        <div style="display: grid; gap: 20px;">
          <div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>Max CPU Usage</span>
              <span style="color: var(--green); font-weight: bold;" id="cpuValue">50%</span>
            </div>
            <input type="range" id="cpuSlider" min="10" max="100" value="50" style="width: 100%; accent-color: var(--green);" oninput="updateSlider('cpu')">
          </div>
          <div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>Max RAM</span>
              <span style="color: var(--green); font-weight: bold;" id="ramValue">2 GB</span>
            </div>
            <input type="range" id="ramSlider" min="256" max="8192" value="2048" step="256" style="width: 100%; accent-color: var(--green);" oninput="updateSlider('ram')">
          </div>
          <div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>Max Bandwidth</span>
              <span style="color: var(--green); font-weight: bold;" id="bwValue">25 Mbps</span>
            </div>
            <input type="range" id="bwSlider" min="1" max="100" value="25" style="width: 100%; accent-color: var(--green);" oninput="updateSlider('bw')">
          </div>
        </div>
      </div>
      
      <!-- Quota Settings -->
      <div class="job-card" style="margin-bottom: 20px;">
        <div class="section-title">üìä DATA QUOTA</div>
        <div style="display: flex; gap: 20px; margin-bottom: 15px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="quotaMode" value="hourly" checked style="accent-color: var(--green);">
            <span>Per Hour</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="quotaMode" value="daily" style="accent-color: var(--green);">
            <span>Per 24 Hours</span>
          </label>
        </div>
        <div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Max Data</span>
            <span style="color: var(--green); font-weight: bold;" id="quotaValue">5 GB</span>
          </div>
          <input type="range" id="quotaSlider" min="1" max="100" value="5" style="width: 100%; accent-color: var(--green);" oninput="updateSlider('quota')">
        </div>
      </div>
      
      <!-- Job Types -->
      <div class="job-card" style="margin-bottom: 20px;">
        <div class="section-title">‚úÖ AUTO-ACCEPT JOB TYPES</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--card-alt); border-radius: 6px; cursor: pointer;">
            <input type="checkbox" id="jobRelay" checked style="accent-color: var(--green); width: 18px; height: 18px;">
            <span>üîó Relay (VPN traffic)</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--card-alt); border-radius: 6px; cursor: pointer;">
            <input type="checkbox" id="jobImage" checked style="accent-color: var(--green); width: 18px; height: 18px;">
            <span>üì∏ AI Image</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--card-alt); border-radius: 6px; cursor: pointer;">
            <input type="checkbox" id="jobAudio" checked style="accent-color: var(--green); width: 18px; height: 18px;">
            <span>üé§ AI Audio</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--card-alt); border-radius: 6px; cursor: pointer;">
            <input type="checkbox" id="jobText" checked style="accent-color: var(--green); width: 18px; height: 18px;">
            <span>üìÑ AI Text</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--card-alt); border-radius: 6px; cursor: pointer;">
            <input type="checkbox" id="jobVideo" style="accent-color: var(--green); width: 18px; height: 18px;">
            <span>üé¨ AI Video</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--card-alt); border-radius: 6px; cursor: pointer;">
            <input type="checkbox" id="jobVerify" checked style="accent-color: var(--green); width: 18px; height: 18px;">
            <span>‚úì Verify</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--card-alt); border-radius: 6px; cursor: pointer;">
            <input type="checkbox" id="jobGpu" style="accent-color: var(--green); width: 18px; height: 18px;">
            <span>üéÆ GPU Render</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--card-alt); border-radius: 6px; cursor: pointer;">
            <input type="checkbox" id="jobJury" style="accent-color: var(--green); width: 18px; height: 18px;">
            <span>‚öñÔ∏è Jury Duty</span>
          </label>
        </div>
      </div>
      
      <!-- Payment Token -->
      <div class="job-card" style="margin-bottom: 20px;">
        <div class="section-title">üí∞ PAYMENT TOKEN</div>
        <div style="display: flex; gap: 15px;">
          <label style="flex: 1; display: flex; align-items: center; gap: 12px; padding: 20px; background: var(--card-alt); border-radius: 8px; cursor: pointer; border: 2px solid var(--border);" id="paymentSolLabel">
            <input type="radio" name="paymentToken" value="SOL" checked style="accent-color: var(--green); width: 20px; height: 20px;" onchange="updatePaymentSelection()">
            <div>
              <div style="font-size: 24px;">‚óé</div>
              <div style="font-weight: bold;">SOL</div>
              <div style="font-size: 10px; color: var(--dim);">Direct payment</div>
            </div>
          </label>
          <label style="flex: 1; display: flex; align-items: center; gap: 12px; padding: 20px; background: var(--card-alt); border-radius: 8px; cursor: pointer; border: 2px solid var(--border);" id="paymentUsdcLabel">
            <input type="radio" name="paymentToken" value="USDC" style="accent-color: var(--green); width: 20px; height: 20px;" onchange="updatePaymentSelection()">
            <div>
              <div style="font-size: 24px;">üíµ</div>
              <div style="font-weight: bold;">USDC</div>
              <div style="font-size: 10px; color: var(--dim);">Auto-swap via Jupiter</div>
            </div>
          </label>
        </div>
        <div id="usdcNote" style="display: none; margin-top: 12px; padding: 10px; background: rgba(88, 166, 255, 0.1); border-radius: 4px; font-size: 11px;">
          ‚ÑπÔ∏è Earnings accumulate in SOL ‚Üí Auto-swap to USDC when ‚â•$0.50 ‚Üí Sent to your wallet
        </div>
      </div>
      
      <!-- Agent Toggle -->
      <div class="job-card" style="border-color: var(--green);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-size: 18px; font-weight: bold;">Agent Status</div>
            <div style="font-size: 12px; color: var(--dim);" id="agentStatusText">Connect wallet to enable</div>
          </div>
          <button id="agentToggleBtn" onclick="toggleAgent()" class="download-btn" style="padding: 15px 40px; font-size: 16px; background: var(--card-alt); opacity: 0.5;" disabled>
            üî¥ OFFLINE
          </button>
        </div>
      </div>
      
    </div>
  </div>
  
  <!-- LIVE JOBS TAB -->
  <div class="tab-content" id="tab-live">
    <div style="padding: 15px 20px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
      <div>
        <span style="color: var(--dim);">Live Job Queue</span>
        <span style="color: var(--green); font-weight: bold; margin-left: 10px;" id="liveJobCount">0 jobs</span>
        <span style="color: var(--dim); margin-left: 20px;">Devnet SOL payments</span>
      </div>
      <div style="display: flex; gap: 10px;">
        <button onclick="fetchLiveJobs()" class="download-btn" style="background: var(--green); color: #000;">üîÑ Refresh</button>
        <button onclick="claimRandomJob()" class="download-btn" id="claimBtn" disabled style="background: var(--cyan); color: #000;">üì• Claim Job</button>
      </div>
    </div>
    <div class="jobs-grid" id="liveJobsGrid">
      <div class="empty-state" style="padding: 40px; grid-column: 1/-1;">
        <div style="font-size: 48px;">‚è≥</div>
        <div style="margin-top: 10px;">Connect wallet to see live jobs</div>
      </div>
    </div>
  </div>
  
  <!-- SCORE TAB -->
  <div class="tab-content" id="tab-score">
    <div style="padding: 20px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 900px; margin: 0 auto;">
        <!-- Your Score -->
        <div class="job-card" style="border-color: var(--cyan);">
          <div class="section-title">Your Agent Score</div>
          <div id="myScoreCard">
            <div class="empty-state" style="padding: 20px;">
              <div style="font-size: 32px;">üëÜ</div>
              <div>Connect wallet to see score</div>
            </div>
          </div>
        </div>
        
        <!-- Score Tiers -->
        <div class="job-card">
          <div class="section-title">Score Tiers</div>
          <div id="tierList">
            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);"><span>üëë ELITE</span><span style="color: var(--green);">99%+ ‚Üí +25% bonus</span></div>
            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);"><span>‚≠ê EXCELLENT</span><span style="color: var(--green);">95%+ ‚Üí +15% bonus</span></div>
            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);"><span>‚ú® GREAT</span><span style="color: var(--green);">90%+ ‚Üí +10% bonus</span></div>
            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);"><span>üëç GOOD</span><span style="color: var(--green);">85%+ ‚Üí +5% bonus</span></div>
            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);"><span>‚ûñ AVERAGE</span><span style="color: var(--dim);">80%+ ‚Üí Base rate</span></div>
            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);"><span>‚ö†Ô∏è POOR</span><span style="color: var(--orange);">70%+ ‚Üí -5% penalty</span></div>
            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);"><span>‚ùå BAD</span><span style="color: var(--orange);">60%+ ‚Üí -10% penalty</span></div>
            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);"><span>üö´ TERRIBLE</span><span style="color: var(--red);">50%+ ‚Üí -20% penalty</span></div>
            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);"><span>üíÄ CRITICAL</span><span style="color: var(--red);">40%+ ‚Üí -30% penalty</span></div>
            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);"><span>üîí SUSPENDED</span><span style="color: var(--red);">30%+ ‚Üí No jobs</span></div>
            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);"><span>‚õî BANNED</span><span style="color: var(--red);">20%+ ‚Üí Account locked</span></div>
            <div style="display: flex; justify-content: space-between; padding: 6px 0;"><span>‚ò†Ô∏è BLACKLIST</span><span style="color: var(--red);"><20% ‚Üí Permanent ban</span></div>
          </div>
        </div>
      </div>
      
      <!-- Leaderboard -->
      <div class="job-card" style="max-width: 900px; margin: 20px auto;">
        <div class="section-title">üèÜ Top Agents Leaderboard</div>
        <div id="leaderboard">
          <div style="display: grid; grid-template-columns: 60px 1fr 100px 100px 100px; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); font-weight: bold; color: var(--dim); font-size: 11px;">
            <div>RANK</div><div>AGENT</div><div>SCORE</div><div>TIER</div><div>EARNED</div>
          </div>
          <div id="leaderboardRows" style="max-height: 400px; overflow-y: auto;">
            <div class="empty-state" style="padding: 30px;">Loading leaderboard...</div>
          </div>
        </div>
      </div>
      
      <!-- Ledger -->
      <div class="job-card" style="max-width: 900px; margin: 20px auto;">
        <div class="section-title">üìí Transaction Ledger (Last 20)</div>
        <div id="ledgerEntries" style="max-height: 300px; overflow-y: auto;">
          <div class="empty-state" style="padding: 20px;">No transactions yet</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- JOBS CATALOG TAB -->
  <div class="tab-content" id="tab-jobs">
    <div style="padding: 15px 20px; background: var(--card); border-bottom: 1px solid var(--border);">
      <span style="color: var(--dim);">Customer pays listed price ‚Üí</span>
      <span style="color: var(--green); font-weight: bold;"> You earn 97%</span>
      <span style="color: var(--dim); margin-left: 20px;">(3% platform fee)</span>
    </div>
    <div class="jobs-grid">
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">üîó Residential Relay</span>
          <span class="job-card-rate">$10.00<span class="job-unit">/GB</span></span>
        </div>
        <div class="job-card-desc">Premium residential bandwidth for web scraping, market research.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$9.50/GB</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üì± Mobile OK</span></div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">üì∏ Image Upscale</span>
          <span class="job-card-rate">$0.05<span class="job-unit">/img</span></span>
        </div>
        <div class="job-card-desc">AI 4x upscale. Used by e-commerce, photographers.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$0.047/img</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üíª Desktop only</span></div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">‚úÇÔ∏è BG Remove</span>
          <span class="job-card-rate">$0.40<span class="job-unit">/img</span></span>
        </div>
        <div class="job-card-desc">Background removal. Used by e-commerce, designers.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$0.38/img</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üíª Desktop only</span></div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">üé§ Transcribe</span>
          <span class="job-card-rate">$0.06<span class="job-unit">/min</span></span>
        </div>
        <div class="job-card-desc">Speech-to-text. Used by podcasters, journalists.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$0.057/min</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üíª Desktop only</span></div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">üåê Translate</span>
          <span class="job-card-rate">$0.02<span class="job-unit">/1K chars</span></span>
        </div>
        <div class="job-card-desc">200+ languages. Used by businesses, content creators.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$0.019/1K</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üíª Desktop only</span></div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">üéÆ GPU Render</span>
          <span class="job-card-rate">$0.40<span class="job-unit">/hr</span></span>
        </div>
        <div class="job-card-desc">3D rendering, ML inference. Used by studios, AI companies.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$0.38/hr</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üéÆ GPU required</span></div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">‚úì Batch Verify</span>
          <span class="job-card-rate">$0.02<span class="job-unit">/batch</span></span>
        </div>
        <div class="job-card-desc">Merkle proof verification for settlement batches.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$0.019/batch</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üì± Any device</span></div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">‚öñÔ∏è Dispute Jury</span>
          <span class="job-card-rate">$0.50<span class="job-unit">/case</span></span>
        </div>
        <div class="job-card-desc">Vote on payment disputes. Requires PDOX stake.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$0.475/case</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üì± Any device</span></div>
      </div>
    </div>
  </div>
  
  <!-- DEPLOY TAB -->
  <div class="tab-content" id="tab-deploy">
    <!-- WAR ROOM LINK -->
    <a href="warroom.html" style="display: block; background: linear-gradient(135deg, #ff0066, #aa0044); border: 2px solid #ff0066; border-radius: 12px; padding: 16px; text-decoration: none; margin: 20px 16px 0;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <span style="font-size: 2rem;">‚öîÔ∏è</span>
        <div style="flex: 1;">
          <div style="color: #fff; font-weight: 700; font-size: 1.1rem;">AGENT WAR ROOM</div>
          <div style="color: rgba(255,255,255,0.8); font-size: 0.75rem;">Live telemetry ‚Ä¢ Global network ‚Ä¢ Mission control</div>
        </div>
        <span style="color: #fff; font-size: 1.2rem;">‚Üí</span>
      </div>
    </a>
    
    <!-- App Logo -->
    <div style="text-align: center; padding: 30px 20px 20px;">
      <img src="../assets/null-logo-256.png" alt="Phantom Agent" style="width: 120px; height: 120px; border-radius: 24px;">
      <div style="margin-top: 16px; font-size: 20px; font-weight: bold; color: var(--green);">Phantom Agent</div>
      <div style="color: var(--dim); font-size: 12px;">Earn PDOX by contributing resources</div>
    </div>
    
    <div class="jobs-grid">
      <!-- ANDROID APP -->
      <div class="job-card" style="border-color: var(--green);">
        <div class="job-card-header">
          <span class="job-card-title">üì± Android App</span>
          <span class="job-card-rate" style="color: var(--green);">‚úì Ready</span>
        </div>
        <div class="job-card-desc">Native Kotlin app with Jetpack Compose.</div>
        <div style="font-size: 10px; color: var(--dim); margin: 8px 0;">Can do: Bandwidth relay</div>
        <div style="font-size: 10px; color: var(--dim);">~1-3 GB/day realistic</div>
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
          <div><span class="stat-value green">0.001-0.002 SOL</span><span style="color: var(--dim)">/day</span></div>
          <div style="font-size: 10px; color: var(--dim);">‚âà $0.15-0.30 USDC</div>
        </div>
        <div style="margin-top: 12px;">
          <a href="phantom-agent-android-v0.1.4.apk" download class="download-btn ready" style="width:100%; display:block; text-align:center;">üì± Download APK v0.1.4</a>
        </div>
        <div style="font-size: 9px; color: var(--dim); margin-top: 8px;">
          Enable "Install from unknown sources" in Settings
        </div>
      </div>
      
      <!-- BROWSER EXTENSIONS -->
      <div class="job-card" style="border-color: var(--green);">
        <div class="job-card-header">
          <span class="job-card-title">üåê Browser Extension</span>
          <span class="job-card-rate" style="color: var(--green);">‚úì Ready</span>
        </div>
        <div class="job-card-desc">Relay while you browse. One-click install.</div>
        <div style="font-size: 10px; color: var(--dim); margin: 8px 0;">Can do: Bandwidth relay</div>
        <div style="font-size: 10px; color: var(--dim);">~2-8 GB/day (8hr use)</div>
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
          <div><span class="stat-value green">0.002-0.005 SOL</span><span style="color: var(--dim)">/day</span></div>
          <div style="font-size: 10px; color: var(--dim);">‚âà $0.30-0.75 USDC</div>
        </div>
        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
          <a href="phantom-agent-chrome-v0.1.0.zip" download class="download-btn ready">üîµ Chrome v0.1.0</a>
          <a href="phantom-agent-firefox-v0.1.0.xpi" download class="download-btn ready">ü¶ä Firefox v0.1.0</a>
        </div>
        <div style="font-size: 9px; color: var(--dim); margin-top: 8px;">
          Chrome: Unzip ‚Üí chrome://extensions ‚Üí Load unpacked<br>
          Firefox: Just click to install
        </div>
      </div>
      
      <!-- DESKTOP AGENT -->
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">üíª Desktop Agent</span>
          <span class="job-card-rate" style="color: var(--orange);">Devnet</span>
        </div>
        <div class="job-card-desc">Full agent with compute + relay + verify.</div>
        <div style="font-size: 10px; color: var(--dim); margin: 8px 0;">Can do: Relay, CPU tasks, verify</div>
        <div style="font-size: 10px; color: var(--dim);">~5-20 GB + CPU tasks</div>
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
          <div><span class="stat-value green">0.005-0.015 SOL</span><span style="color: var(--dim)">/day</span></div>
          <div style="font-size: 10px; color: var(--dim);">‚âà $0.75-2.25 USDC</div>
        </div>
        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
          <span class="download-btn disabled">‚äû Win - Soon</span>
          <span class="download-btn disabled">üçé Mac - Soon</span>
          <span class="download-btn disabled">üêß Linux - Soon</span>
        </div>
      </div>
      
      <!-- PHANTOM BOX -->
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">üî≤ Phantom Box</span>
          <span class="job-card-rate" style="color: var(--dim);">Coming Soon</span>
        </div>
        <div class="job-card-desc">Always-on. All job types. Plug & play.</div>
        <div style="font-size: 10px; color: var(--dim); margin: 8px 0;">Can do: Relay, CPU, verify, storage</div>
        <div style="font-size: 10px; color: var(--dim);">24/7 uptime = max jobs</div>
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
          <div><span class="stat-value green">0.01-0.03 SOL</span><span style="color: var(--dim)">/day</span></div>
          <div style="font-size: 10px; color: var(--dim);">‚âà $1.50-4.50 USDC</div>
        </div>
        <div style="margin-top: 12px;">
          <span class="download-btn disabled" style="width:100%;display:block;text-align:center;">üçì Coming Soon</span>
        </div>
      </div>
    </div>
    <div style="max-width: 800px; margin: 20px auto; padding: 15px; background: var(--card); border: 1px solid var(--border); border-radius: 6px;">
      <div style="font-weight: bold; color: var(--orange); margin-bottom: 10px;">‚ö†Ô∏è Earnings depend on:</div>
      <div style="font-size: 12px; color: var(--dim); display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
        <div>‚Ä¢ Your location (demand varies)</div>
        <div>‚Ä¢ Network quality (80%+ required)</div>
        <div>‚Ä¢ Uptime (more hours = more jobs)</div>
        <div>‚Ä¢ Hardware (CPU/RAM/bandwidth)</div>
      </div>
      <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 11px; color: var(--red);">
        Quality below 80% = stake slashed. Repeated failures = ban.
      </div>
    </div>
  </div>

<script>
// City coordinates with lat/lng for D3 projection
const CITIES = {
  'Europe/Vilnius': { lat: 54.68, lng: 25.28, name: 'Vilnius' },
  'Europe/Riga': { lat: 56.95, lng: 24.10, name: 'Riga' },
  'Europe/Tallinn': { lat: 59.43, lng: 24.75, name: 'Tallinn' },
  'Europe/Warsaw': { lat: 52.23, lng: 21.01, name: 'Warsaw' },
  'Europe/Berlin': { lat: 52.52, lng: 13.40, name: 'Berlin' },
  'Europe/Paris': { lat: 48.85, lng: 2.35, name: 'Paris' },
  'Europe/London': { lat: 51.51, lng: -0.12, name: 'London' },
  'Europe/Amsterdam': { lat: 52.37, lng: 4.90, name: 'Amsterdam' },
  'Europe/Moscow': { lat: 55.75, lng: 37.62, name: 'Moscow' },
  'Europe/Kiev': { lat: 50.45, lng: 30.52, name: 'Kyiv' },
  'Europe/Kyiv': { lat: 50.45, lng: 30.52, name: 'Kyiv' },
  'Europe/Minsk': { lat: 53.90, lng: 27.57, name: 'Minsk' },
  'Europe/Helsinki': { lat: 60.17, lng: 24.94, name: 'Helsinki' },
  'Europe/Rome': { lat: 41.90, lng: 12.50, name: 'Rome' },
  'Europe/Madrid': { lat: 40.42, lng: -3.70, name: 'Madrid' },
  'Europe/Stockholm': { lat: 59.33, lng: 18.07, name: 'Stockholm' },
  'America/New_York': { lat: 40.71, lng: -74.01, name: 'New York' },
  'America/Los_Angeles': { lat: 34.05, lng: -118.24, name: 'Los Angeles' },
  'America/Chicago': { lat: 41.88, lng: -87.63, name: 'Chicago' },
  'America/Toronto': { lat: 43.65, lng: -79.38, name: 'Toronto' },
  'America/Sao_Paulo': { lat: -23.55, lng: -46.63, name: 'S√£o Paulo' },
  'Asia/Tokyo': { lat: 35.68, lng: 139.69, name: 'Tokyo' },
  'Asia/Seoul': { lat: 37.57, lng: 126.98, name: 'Seoul' },
  'Asia/Shanghai': { lat: 31.23, lng: 121.47, name: 'Shanghai' },
  'Asia/Singapore': { lat: 1.35, lng: 103.82, name: 'Singapore' },
  'Asia/Dubai': { lat: 25.20, lng: 55.27, name: 'Dubai' },
  'Asia/Hong_Kong': { lat: 22.32, lng: 114.17, name: 'Hong Kong' },
  'Australia/Sydney': { lat: -33.87, lng: 151.21, name: 'Sydney' },
};

let agents = [];
let myAgent = null;
let connectedWallet = null;
let map = null;
let myMarker = null;

// Initialize
function init() {
  drawMap();
  setupTabs();
  setupConnect();
}

function drawMap() {
  // Initialize Leaflet map with bounds lock
  var bounds = L.latLngBounds(L.latLng(-85, -180), L.latLng(85, 180));
  map = L.map('mapContainer', {
    center: [30, 0],
    zoom: 2,
    minZoom: 2,
    maxZoom: 6,
    zoomControl: false,
    attributionControl: false,
    maxBounds: bounds,
    maxBoundsViscosity: 1.0
  });
  
  // CartoDB Dark (truly free, no API key)
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    subdomains: 'abcd',
    maxZoom: 19,
    attribution: ''
  }).addTo(map);
  
  console.log('Map loaded: CartoDB Dark');
}

function setupTabs() {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    });
  });
}

function setupConnect() {
  const btn = document.getElementById('connectBtn');
  btn.addEventListener('click', connectWallet);
  
  // Auto-reconnect if already connected
  checkExistingConnection();
}

async function checkExistingConnection() {
  // Check Phantom
  if (window.phantom?.solana?.isConnected) {
    try {
      const resp = await window.phantom.solana.connect({ onlyIfTrusted: true });
      if (resp.publicKey) {
        connectedWallet = resp.publicKey.toString();
        onConnected(connectedWallet);
        return;
      }
    } catch (e) {}
  }
  // Check legacy window.solana
  if (window.solana?.isConnected && window.solana?.publicKey) {
    connectedWallet = window.solana.publicKey.toString();
    onConnected(connectedWallet);
  }
}

async function connectWallet() {
  const btn = document.getElementById('connectBtn');
  btn.textContent = 'CONNECTING...';
  btn.disabled = true;
  
  try {
    // Try Phantom (new API)
    const provider = window.phantom?.solana || window.solana;
    
    if (provider?.isPhantom) {
      const resp = await provider.connect();
      connectedWallet = resp.publicKey.toString();
      onConnected(connectedWallet);
      return;
    }
    
    // Try Solflare
    if (window.solflare) {
      await window.solflare.connect();
      if (window.solflare.publicKey) {
        connectedWallet = window.solflare.publicKey.toString();
        onConnected(connectedWallet);
        return;
      }
    }
    
    // No wallet found
    btn.textContent = 'CONNECT WALLET';
    btn.disabled = false;
    window.open('https://phantom.app/', '_blank');
    
  } catch (err) {
    console.error('Connection failed:', err);
    btn.textContent = 'CONNECT WALLET';
    btn.disabled = false;
  }
}

function onConnected(wallet) {
  const btn = document.getElementById('connectBtn');
  btn.textContent = wallet.slice(0, 4) + '...' + wallet.slice(-4);
  btn.classList.add('connected');
  
  document.getElementById('statusBadge').textContent = 'ONLINE';
  document.getElementById('statusBadge').style.background = 'var(--cyan)';
  
  // Get city from timezone (most reliable for city NAME)
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const tzCity = CITIES[tz];
  
  if (tzCity) {
    // Use timezone city - most accurate for name
    // Try to get real coords for more precise marker position
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          // Use real coords but timezone city name
          setupAgent(wallet, pos.coords.latitude, pos.coords.longitude, tzCity.name);
        },
        () => {
          // Use timezone city coords
          setupAgent(wallet, tzCity.lat, tzCity.lng, tzCity.name);
        },
        { timeout: 3000, maximumAge: 300000 }
      );
    } else {
      setupAgent(wallet, tzCity.lat, tzCity.lng, tzCity.name);
    }
  } else {
    // Unknown timezone - try geolocation
    const fallbackName = tz.split('/')[1] || 'Unknown';
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          setupAgent(wallet, pos.coords.latitude, pos.coords.longitude, fallbackName);
        },
        () => {
          setupAgent(wallet, 51.5, 0, fallbackName);
        },
        { timeout: 3000 }
      );
    } else {
      setupAgent(wallet, 51.5, 0, fallbackName);
    }
  }
}

function setupAgent(wallet, lat, lng, cityName) {
  myAgent = {
    wallet: wallet,
    lat: lat,
    lng: lng,
    city: cityName,
    latency: 0,
    bandwidth: 0,
    capLevel: 3,
    isMe: true
  };
  
  // Test network
  testNetwork();
  
  // Render
  renderAgents();
  renderYourAgent();
  
  console.log('Connected:', wallet, 'Location:', cityName, `(${lat.toFixed(2)}, ${lng.toFixed(2)})`);
}

async function testNetwork() {
  if (!myAgent) return;
  
  // Test latency
  const start = performance.now();
  try {
    await fetch('https://api.devnet.solana.com', { method: 'HEAD', mode: 'no-cors' });
    myAgent.latency = Math.floor(performance.now() - start);
  } catch (e) {
    myAgent.latency = 999;
  }
  
  // Estimate bandwidth
  myAgent.bandwidth = 25 + Math.floor(Math.random() * 50);
  
  renderYourAgent();
}

function renderAgents() {
  if (!map) return;
  
  // Remove existing marker
  if (myMarker) {
    map.removeLayer(myMarker);
    myMarker = null;
  }
  
  // Add my agent marker
  if (myAgent && myAgent.lat && myAgent.lng) {
    const icon = L.divIcon({
      className: 'agent-marker-you',
      html: '<div class="marker-pulse"></div>',
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });
    
    myMarker = L.marker([myAgent.lat, myAgent.lng], { icon: icon })
      .addTo(map)
      .bindPopup(`<b>YOU</b><br>${myAgent.city}<br>${myAgent.latency}ms`);
    
    // Center map on user
    map.setView([myAgent.lat, myAgent.lng], 4);
  }
  
  // Add other agents
  agents.forEach(agent => {
    if (!agent.lat || !agent.lng) return;
    const capColors = ['#6e7681', '#3fb950', '#39c5cf', '#a371f7', '#d29922'];
    const color = capColors[agent.capLevel] || '#3fb950';
    
    const icon = L.divIcon({
      className: 'agent-marker',
      html: `<div style="background:${color};width:8px;height:8px;border-radius:50%;"></div>`,
      iconSize: [8, 8],
      iconAnchor: [4, 4]
    });
    
    L.marker([agent.lat, agent.lng], { icon: icon })
      .addTo(map)
      .bindPopup(`${agent.city}<br>${agent.latency}ms`);
  });
  
  // Update stats
  const total = agents.length + (myAgent ? 1 : 0);
  document.getElementById('onlineCount').textContent = total;
  document.getElementById('regionCount').textContent = new Set([...agents.map(a => a.city), myAgent?.city].filter(Boolean)).size;
  const bw = agents.reduce((a, b) => a + (b.bandwidth || 0), myAgent?.bandwidth || 0);
  document.getElementById('totalBw').textContent = (bw / 1000).toFixed(1);
}

function renderYourAgent() {
  const container = document.getElementById('yourAgent');
  
  if (!myAgent) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 20px;">
        <div style="font-size: 24px; margin-bottom: 10px;">üëÜ</div>
        <div>Click CONNECT WALLET</div>
        <div style="font-size: 10px;">to show your agent</div>
      </div>
    `;
    return;
  }
  
  const latClass = myAgent.latency < 100 ? 'good' : myAgent.latency < 200 ? 'warn' : '';
  const bwClass = myAgent.bandwidth > 30 ? 'good' : myAgent.bandwidth > 10 ? 'warn' : '';
  
  container.innerHTML = `
    <div class="agent-item you">
      <div class="agent-addr">‚≠ê ${myAgent.wallet.slice(0, 8)}...${myAgent.wallet.slice(-4)}</div>
      <div class="agent-location">üìç ${myAgent.city} (YOU)</div>
      <div class="agent-metrics">
        <div class="agent-metric"><span>Latency:</span> <strong class="${latClass}">${myAgent.latency || '--'}ms</strong></div>
        <div class="agent-metric"><span>Bandwidth:</span> <strong class="${bwClass}">${myAgent.bandwidth || '--'} Mbps</strong></div>
      </div>
    </div>
  `;
}

function renderAgentList() {
  const list = document.getElementById('agentList');
  
  if (agents.length === 0) {
    list.innerHTML = '<div class="empty-state" style="padding: 20px;">No other agents online</div>';
    return;
  }
  
  // Only show REAL agents from devnet
  list.innerHTML = agents.slice(0, 10).map(agent => `
    <div class="agent-item">
      <div class="agent-addr">${agent.wallet.slice(0, 8)}...${agent.wallet.slice(-4)}</div>
      <div class="agent-location">üìç ${agent.city}</div>
      <div class="agent-metrics">
        <div class="agent-metric"><span>Latency:</span> <strong>${agent.latency}ms</strong></div>
        <div class="agent-metric"><span>BW:</span> <strong>${agent.bandwidth} Mbps</strong></div>
      </div>
    </div>
  `).join('');
}

// ============== LIVE JOBS SIMULATION ==============

const LAMPORTS_PER_SOL = 1_000_000_000;
let liveJobs = [];
let myScore = { score: 8000, tier: 'AVERAGE', emoji: '‚ûñ', earned: 0, jobs: 0, streak: 0 };
let ledger = [];
let leaderboard = [];

const JOB_TEMPLATES = [
  { cat: 'RELAY', type: 'vpn_tunnel', title: 'üîó VPN Relay', rate: 1000000, unit: 'MB' },
  { cat: 'RELAY', type: 'geo_unlock', title: 'üåç Geo-Unlock', rate: 2000000, unit: 'MB' },
  { cat: 'AI_IMAGE', type: 'photo_enhance', title: 'üì∏ 4x Upscale', rate: 20000000, unit: 'image' },
  { cat: 'AI_IMAGE', type: 'bg_remove', title: '‚úÇÔ∏è BG Remove', rate: 10000000, unit: 'image' },
  { cat: 'AI_IMAGE', type: 'style_transfer', title: 'üé® Style Transfer', rate: 30000000, unit: 'image' },
  { cat: 'AI_AUDIO', type: 'transcribe', title: 'üé§ Transcribe', rate: 50000000, unit: 'minute' },
  { cat: 'AI_AUDIO', type: 'translate', title: 'üåê Translate Audio', rate: 80000000, unit: 'minute' },
  { cat: 'AI_TEXT', type: 'summarize', title: 'üìÑ Summarize', rate: 10000000, unit: 'page' },
  { cat: 'AI_TEXT', type: 'ocr', title: 'üìù OCR', rate: 5000000, unit: 'page' },
  { cat: 'AI_VIDEO', type: 'compress', title: 'üé¨ Video Compress', rate: 100000000, unit: 'minute' },
  { cat: 'VERIFICATION', type: 'merkle', title: '‚úì Merkle Verify', rate: 20000000, unit: 'batch' },
  { cat: 'VERIFICATION', type: 'jury', title: '‚öñÔ∏è Jury Duty', rate: 500000000, unit: 'case' },
  { cat: 'COMPUTE', type: 'cpu', title: 'üíª CPU Task', rate: 5000000, unit: 'minute' },
  { cat: 'COMPUTE', type: 'ml', title: 'üß† ML Inference', rate: 50000000, unit: 'batch' },
];

const TIERS = [
  { min: 9900, name: 'ELITE', emoji: 'üëë', mult: 1.25, color: '#FFD700' },
  { min: 9500, name: 'EXCELLENT', emoji: '‚≠ê', mult: 1.15, color: '#00FF88' },
  { min: 9000, name: 'GREAT', emoji: '‚ú®', mult: 1.10, color: '#00D4FF' },
  { min: 8500, name: 'GOOD', emoji: 'üëç', mult: 1.05, color: '#88FF88' },
  { min: 8000, name: 'AVERAGE', emoji: '‚ûñ', mult: 1.00, color: '#AAAAAA' },
  { min: 7000, name: 'POOR', emoji: '‚ö†Ô∏è', mult: 0.95, color: '#FFAA00' },
  { min: 6000, name: 'BAD', emoji: '‚ùå', mult: 0.90, color: '#FF6600' },
  { min: 5000, name: 'TERRIBLE', emoji: 'üö´', mult: 0.80, color: '#FF4444' },
  { min: 4000, name: 'CRITICAL', emoji: 'üíÄ', mult: 0.70, color: '#FF0000' },
  { min: 3000, name: 'SUSPENDED', emoji: 'üîí', mult: 0, color: '#880000' },
  { min: 2000, name: 'BANNED', emoji: '‚õî', mult: 0, color: '#440000' },
  { min: 0, name: 'BLACKLIST', emoji: '‚ò†Ô∏è', mult: 0, color: '#000000' },
];

function getTier(score) {
  return TIERS.find(t => score >= t.min) || TIERS[TIERS.length - 1];
}

function genJobId() {
  return 'JOB-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
}

function createSimJob() {
  const t = JOB_TEMPLATES[Math.floor(Math.random() * JOB_TEMPLATES.length)];
  const size = Math.floor(1 + Math.random() * 10);
  const price = t.rate * size;
  const clients = ['Brain7x..Corp', 'Brain9k..Labs', 'BrainAI..DAO', 'Brain2m..Tech'];
  
  return {
    id: genJobId(),
    category: t.cat,
    type: t.type,
    title: t.title,
    price: price,
    priceSOL: price / LAMPORTS_PER_SOL,
    size: size + ' ' + t.unit,
    client: clients[Math.floor(Math.random() * clients.length)],
    createdAt: new Date(),
    deadline: new Date(Date.now() + 300000), // 5 min
  };
}

function fetchLiveJobs() {
  // Generate 5-10 jobs
  liveJobs = [];
  for (let i = 0; i < 5 + Math.floor(Math.random() * 6); i++) {
    liveJobs.push(createSimJob());
  }
  renderLiveJobs();
}

function renderLiveJobs() {
  const grid = document.getElementById('liveJobsGrid');
  const count = document.getElementById('liveJobCount');
  const claimBtn = document.getElementById('claimBtn');
  
  count.textContent = liveJobs.length + ' jobs';
  claimBtn.disabled = !connectedWallet || liveJobs.length === 0;
  
  if (liveJobs.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="padding: 40px; grid-column: 1/-1;"><div style="font-size: 48px;">üì≠</div><div>No jobs available. Click Refresh!</div></div>';
    return;
  }
  
  grid.innerHTML = liveJobs.map(job => `
    <div class="job-card" style="border-left: 3px solid var(--${job.category === 'AI_IMAGE' ? 'purple' : job.category === 'RELAY' ? 'green' : job.category === 'VERIFICATION' ? 'blue' : 'cyan'});">
      <div class="job-card-header">
        <span class="job-card-title">${job.title}</span>
        <span class="job-card-rate">${job.priceSOL.toFixed(4)} SOL</span>
      </div>
      <div class="job-card-desc">${job.size} from ${job.client}</div>
      <div style="margin-top: 8px; font-size: 10px; color: var(--dim);">ID: ${job.id.slice(0, 16)}...</div>
      <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">${(job.priceSOL * 0.97).toFixed(4)} SOL</span></div>
      <button onclick="claimJob('${job.id}')" class="download-btn" style="margin-top: 10px; width: 100%; ${!connectedWallet ? 'opacity: 0.5;' : ''}">üì• Claim This Job</button>
    </div>
  `).join('');
}

function claimRandomJob() {
  if (liveJobs.length === 0) return;
  const job = liveJobs[Math.floor(Math.random() * liveJobs.length)];
  claimJob(job.id);
}

function claimJob(jobId) {
  if (!connectedWallet) {
    alert('Connect wallet first!');
    return;
  }
  
  const job = liveJobs.find(j => j.id === jobId);
  if (!job) return;
  
  // Remove from available
  liveJobs = liveJobs.filter(j => j.id !== jobId);
  
  // Simulate completion (90% success rate)
  const success = Math.random() < 0.90;
  const quality = 70 + Math.floor(Math.random() * 30);
  const onTime = Math.random() < 0.85;
  
  // Calculate score change
  let change = 0;
  if (success) {
    change = 10 + Math.floor(quality / 2);
    if (onTime) change += 20;
    if (myScore.streak >= 3) change += Math.min(50, myScore.streak * 5);
    change = Math.min(change, 150);
    myScore.streak++;
    myScore.jobs++;
    
    const earned = job.price * 0.97;
    myScore.earned += earned;
    
    // Add ledger entry
    ledger.unshift({
      type: 'JOB_PAYMENT',
      to: connectedWallet.slice(0, 8) + '..',
      amount: earned,
      desc: `Payment: ${job.title}`,
      time: new Date(),
    });
    
  } else {
    change = myScore.streak === 0 ? -150 : -100;
    myScore.streak = 0;
    myScore.jobs++;
    
    ledger.unshift({
      type: 'PENALTY',
      to: connectedWallet.slice(0, 8) + '..',
      amount: 0,
      desc: `Job failed: ${job.title}`,
      time: new Date(),
    });
  }
  
  const oldScore = myScore.score;
  const oldTier = getTier(oldScore);
  myScore.score = Math.max(0, Math.min(10000, myScore.score + change));
  const newTier = getTier(myScore.score);
  myScore.tier = newTier.name;
  myScore.emoji = newTier.emoji;
  
  // Update leaderboard
  updateLeaderboard();
  
  // Render
  renderLiveJobs();
  renderMyScore();
  renderLedger();
  
  // Alert
  if (success) {
    alert(`‚úÖ Job completed!\n\nQuality: ${quality}%\nOn Time: ${onTime ? 'Yes' : 'No'}\nEarned: ${(job.price * 0.97 / LAMPORTS_PER_SOL).toFixed(4)} SOL\n\nScore: ${oldScore} ‚Üí ${myScore.score} (${change > 0 ? '+' : ''}${change})\nTier: ${oldTier.emoji} ${oldTier.name} ‚Üí ${newTier.emoji} ${newTier.name}`);
  } else {
    alert(`‚ùå Job failed!\n\nScore: ${oldScore} ‚Üí ${myScore.score} (${change})\nStreak reset to 0`);
  }
}

function renderMyScore() {
  const card = document.getElementById('myScoreCard');
  
  if (!connectedWallet) {
    card.innerHTML = '<div class="empty-state" style="padding: 20px;"><div style="font-size: 32px;">üëÜ</div><div>Connect wallet to see score</div></div>';
    return;
  }
  
  const tier = getTier(myScore.score);
  
  card.innerHTML = `
    <div style="text-align: center; padding: 20px;">
      <div style="font-size: 48px;">${tier.emoji}</div>
      <div style="font-size: 32px; font-weight: bold; color: ${tier.color};">${tier.name}</div>
      <div style="font-size: 24px; margin: 10px 0;">${(myScore.score / 100).toFixed(2)}%</div>
      <div style="background: var(--card-alt); border-radius: 4px; height: 20px; overflow: hidden; margin: 15px 0;">
        <div style="height: 100%; width: ${myScore.score / 100}%; background: ${tier.color}; transition: width 0.3s;"></div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 12px;">
        <div><div style="color: var(--dim);">Jobs</div><div style="font-weight: bold;">${myScore.jobs}</div></div>
        <div><div style="color: var(--dim);">Streak</div><div style="font-weight: bold; color: var(--green);">üî• ${myScore.streak}</div></div>
        <div><div style="color: var(--dim);">Earned</div><div style="font-weight: bold; color: var(--green);">${(myScore.earned / LAMPORTS_PER_SOL).toFixed(4)} SOL</div></div>
      </div>
      <div style="margin-top: 15px; font-size: 11px; color: var(--dim);">Multiplier: ${tier.mult}x</div>
    </div>
  `;
}

function renderLedger() {
  const container = document.getElementById('ledgerEntries');
  
  if (ledger.length === 0) {
    container.innerHTML = '<div class="empty-state" style="padding: 20px;">No transactions yet</div>';
    return;
  }
  
  container.innerHTML = ledger.slice(0, 20).map(e => `
    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 11px;">
      <div>
        <span style="color: ${e.type === 'JOB_PAYMENT' ? 'var(--green)' : 'var(--red)'};">${e.type === 'JOB_PAYMENT' ? 'üì•' : '‚ö†Ô∏è'} ${e.type}</span>
        <span style="color: var(--dim); margin-left: 10px;">${e.desc}</span>
      </div>
      <div>
        <span style="color: ${e.amount > 0 ? 'var(--green)' : 'var(--dim)'};">${e.amount > 0 ? '+' + (e.amount / LAMPORTS_PER_SOL).toFixed(4) + ' SOL' : '-'}</span>
      </div>
    </div>
  `).join('');
}

function updateLeaderboard() {
  // Add myself if not exists
  const myIdx = leaderboard.findIndex(a => a.wallet === connectedWallet);
  if (myIdx >= 0) {
    leaderboard[myIdx] = { wallet: connectedWallet, ...myScore };
  } else if (connectedWallet) {
    leaderboard.push({ wallet: connectedWallet, ...myScore });
  }
  
  // Add some fake agents
  if (leaderboard.length < 10) {
    const fakeAgents = [
      { wallet: 'Elite9x..AAA', score: 9950, tier: 'ELITE', earned: 125000000000 },
      { wallet: 'Star7k..BBB', score: 9600, tier: 'EXCELLENT', earned: 98000000000 },
      { wallet: 'Great5m..CCC', score: 9200, tier: 'GREAT', earned: 72000000000 },
      { wallet: 'Good3n..DDD', score: 8700, tier: 'GOOD', earned: 45000000000 },
      { wallet: 'Avg2p..EEE', score: 8200, tier: 'AVERAGE', earned: 23000000000 },
      { wallet: 'Work1q..FFF', score: 7800, tier: 'POOR', earned: 12000000000 },
      { wallet: 'Try8r..GGG', score: 6500, tier: 'BAD', earned: 5000000000 },
    ];
    fakeAgents.forEach(a => {
      if (!leaderboard.find(l => l.wallet === a.wallet)) {
        leaderboard.push(a);
      }
    });
  }
  
  // Sort by score
  leaderboard.sort((a, b) => b.score - a.score);
  renderLeaderboard();
}

function renderLeaderboard() {
  const rows = document.getElementById('leaderboardRows');
  
  if (leaderboard.length === 0) {
    rows.innerHTML = '<div class="empty-state" style="padding: 30px;">No agents yet</div>';
    return;
  }
  
  rows.innerHTML = leaderboard.slice(0, 50).map((a, i) => {
    const tier = getTier(a.score);
    const isMe = a.wallet === connectedWallet;
    return `
      <div style="display: grid; grid-template-columns: 60px 1fr 100px 100px 100px; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 12px; ${isMe ? 'background: rgba(57, 197, 207, 0.1);' : ''}">
        <div style="font-weight: bold; ${i < 3 ? 'color: var(--green);' : ''}">#${i + 1}</div>
        <div style="color: ${isMe ? 'var(--cyan)' : 'var(--text)'};">${a.wallet.slice(0, 8)}..${a.wallet.slice(-4)} ${isMe ? '(YOU)' : ''}</div>
        <div>${(a.score / 100).toFixed(2)}%</div>
        <div style="color: ${tier.color};">${tier.emoji} ${tier.name}</div>
        <div style="color: var(--green);">${(a.earned / LAMPORTS_PER_SOL).toFixed(2)} SOL</div>
      </div>
    `;
  }).join('');
}

// Initialize live jobs when wallet connects
function initLiveJobs() {
  fetchLiveJobs();
  renderMyScore();
  updateLeaderboard();
  renderLedger();
  
  // Enable claim button
  document.getElementById('claimBtn').disabled = false;
}

// Extend onConnected to init live jobs
const originalOnConnected = onConnected;
onConnected = function(wallet) {
  originalOnConnected(wallet);
  initLiveJobs();
  renderAgentList();
};

// ============== AGENT CONFIG ==============

let agentConfig = {
  cpu: 50,
  ram: 2048,
  bandwidth: 25,
  quotaMode: 'hourly',
  quota: 5,
  paymentToken: 'SOL',
  jobs: {
    relay: true,
    image: true,
    audio: true,
    text: true,
    video: false,
    verify: true,
    gpu: false,
    jury: false
  },
  isRunning: false
};

// Load config from localStorage
function loadConfig() {
  const saved = localStorage.getItem('agentConfig');
  if (saved) {
    agentConfig = { ...agentConfig, ...JSON.parse(saved) };
    applyConfigToUI();
  }
}

// Save config to localStorage
function saveConfig() {
  localStorage.setItem('agentConfig', JSON.stringify(agentConfig));
  logAudit('CONFIG_SAVE', 'Agent config saved', agentConfig);
}

// Apply saved config to UI
function applyConfigToUI() {
  document.getElementById('cpuSlider').value = agentConfig.cpu;
  document.getElementById('ramSlider').value = agentConfig.ram;
  document.getElementById('bwSlider').value = agentConfig.bandwidth;
  document.getElementById('quotaSlider').value = agentConfig.quota;
  
  document.querySelector(`input[name="quotaMode"][value="${agentConfig.quotaMode}"]`).checked = true;
  document.querySelector(`input[name="paymentToken"][value="${agentConfig.paymentToken}"]`).checked = true;
  
  document.getElementById('jobRelay').checked = agentConfig.jobs.relay;
  document.getElementById('jobImage').checked = agentConfig.jobs.image;
  document.getElementById('jobAudio').checked = agentConfig.jobs.audio;
  document.getElementById('jobText').checked = agentConfig.jobs.text;
  document.getElementById('jobVideo').checked = agentConfig.jobs.video;
  document.getElementById('jobVerify').checked = agentConfig.jobs.verify;
  document.getElementById('jobGpu').checked = agentConfig.jobs.gpu;
  document.getElementById('jobJury').checked = agentConfig.jobs.jury;
  
  updateSlider('cpu');
  updateSlider('ram');
  updateSlider('bw');
  updateSlider('quota');
  updatePaymentSelection();
}

// Update slider display
function updateSlider(type) {
  switch(type) {
    case 'cpu':
      const cpu = document.getElementById('cpuSlider').value;
      document.getElementById('cpuValue').textContent = cpu + '%';
      agentConfig.cpu = parseInt(cpu);
      break;
    case 'ram':
      const ram = document.getElementById('ramSlider').value;
      const ramGB = (ram / 1024).toFixed(1);
      document.getElementById('ramValue').textContent = ramGB + ' GB';
      agentConfig.ram = parseInt(ram);
      break;
    case 'bw':
      const bw = document.getElementById('bwSlider').value;
      document.getElementById('bwValue').textContent = bw + ' Mbps';
      agentConfig.bandwidth = parseInt(bw);
      break;
    case 'quota':
      const quota = document.getElementById('quotaSlider').value;
      document.getElementById('quotaValue').textContent = quota + ' GB';
      agentConfig.quota = parseInt(quota);
      break;
  }
  saveConfig();
}

// Payment token selection
function updatePaymentSelection() {
  const sol = document.getElementById('paymentSolLabel');
  const usdc = document.getElementById('paymentUsdcLabel');
  const note = document.getElementById('usdcNote');
  const selected = document.querySelector('input[name="paymentToken"]:checked').value;
  
  agentConfig.paymentToken = selected;
  
  if (selected === 'SOL') {
    sol.style.borderColor = 'var(--green)';
    usdc.style.borderColor = 'var(--border)';
    note.style.display = 'none';
  } else {
    sol.style.borderColor = 'var(--border)';
    usdc.style.borderColor = 'var(--green)';
    note.style.display = 'block';
  }
  saveConfig();
}

// Gear test
async function runGearTest() {
  const prompt = document.getElementById('gearTestPrompt');
  const results = document.getElementById('gearTestResults');
  
  if (!prompt || !results) {
    console.error('Gear test elements not found');
    alert('Error: Gear test UI not found');
    return;
  }
  
  prompt.innerHTML = '<div style="text-align:center;padding:30px;"><div style="font-size:32px;">‚è≥</div><div>Running tests...</div></div>';
  
  try {
    // Detect CPU cores
    const cpuCores = navigator.hardwareConcurrency || 4;
    
    // Estimate RAM (Chrome only, fallback to 4GB)
    const ram = navigator.deviceMemory || 4;
    
    // Test latency to Solana devnet
    let speed = 25;
    let latency = 100;
    
    const start = performance.now();
    try {
      await fetch('https://api.devnet.solana.com', { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: 'getHealth' }) });
      latency = Math.floor(performance.now() - start);
    } catch(e) {
      // Fallback ping test
      try {
        await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors', cache: 'no-store' });
        latency = Math.floor(performance.now() - start);
      } catch(e2) {
        latency = 150;
      }
    }
    
    // Estimate speed from latency (rough)
    speed = Math.max(10, Math.min(100, Math.floor(200 - latency)));
    
    // Show results
    document.getElementById('gearCpu').textContent = cpuCores;
    document.getElementById('gearRam').textContent = ram;
    document.getElementById('gearSpeed').textContent = speed;
    document.getElementById('gearLatency').textContent = latency;
    
    // Set suggested values
    document.getElementById('cpuSlider').value = Math.min(50, cpuCores * 10);
    document.getElementById('ramSlider').value = Math.min(ram * 1024, 4096);
    document.getElementById('bwSlider').value = Math.min(speed, 50);
    
    updateSlider('cpu');
    updateSlider('ram');
    updateSlider('bw');
    
    prompt.style.display = 'none';
    results.style.display = 'block';
    
    logAudit('GEAR_TEST', 'Hardware scan completed', { cpuCores, ram, speed, latency });
    
  } catch(err) {
    console.error('Gear test failed:', err);
    prompt.innerHTML = '<div style="text-align:center;padding:30px;color:var(--red);"><div style="font-size:32px;">‚ùå</div><div>Test failed. Try again.</div><button onclick="runGearTest()" class="download-btn" style="margin-top:15px;">üîÑ Retry</button></div>';
  }
}

// Toggle agent on/off
function toggleAgent() {
  if (!connectedWallet) {
    alert('Connect wallet first!');
    return;
  }
  
  const btn = document.getElementById('agentToggleBtn');
  const status = document.getElementById('agentStatusText');
  
  agentConfig.isRunning = !agentConfig.isRunning;
  
  if (agentConfig.isRunning) {
    btn.innerHTML = 'üü¢ ONLINE';
    btn.style.background = 'var(--green)';
    btn.style.color = '#000';
    status.textContent = 'Auto-picking jobs matching your config';
    status.style.color = 'var(--green)';
    
    logAudit('AGENT_START', 'Agent started', {
      wallet: connectedWallet,
      config: agentConfig
    });
    
    // Start auto-picking jobs
    startAutoPickJobs();
  } else {
    btn.innerHTML = 'üî¥ OFFLINE';
    btn.style.background = 'var(--card-alt)';
    btn.style.color = 'var(--text)';
    status.textContent = 'Agent stopped';
    status.style.color = 'var(--dim)';
    
    logAudit('AGENT_STOP', 'Agent stopped', { wallet: connectedWallet });
  }
  
  saveConfig();
}

// Auto-pick jobs based on config
let autoPickInterval = null;

function startAutoPickJobs() {
  if (autoPickInterval) clearInterval(autoPickInterval);
  
  autoPickInterval = setInterval(() => {
    if (!agentConfig.isRunning || liveJobs.length === 0) return;
    
    // Find matching job
    const matchingJob = liveJobs.find(job => {
      if (job.category === 'RELAY' && !agentConfig.jobs.relay) return false;
      if (job.category === 'AI_IMAGE' && !agentConfig.jobs.image) return false;
      if (job.category === 'AI_AUDIO' && !agentConfig.jobs.audio) return false;
      if (job.category === 'AI_TEXT' && !agentConfig.jobs.text) return false;
      if (job.category === 'AI_VIDEO' && !agentConfig.jobs.video) return false;
      if (job.category === 'VERIFICATION' && !agentConfig.jobs.verify) return false;
      if (job.category === 'COMPUTE' && !agentConfig.jobs.gpu) return false;
      return true;
    });
    
    if (matchingJob) {
      logAudit('JOB_AUTO_CLAIM', 'Auto-claimed job', { jobId: matchingJob.id, type: matchingJob.type });
      claimJob(matchingJob.id);
    }
  }, 5000); // Check every 5 seconds
}

// ============== CORPORATE AUDIT LOG ==============

const auditLog = [];

function logAudit(action, description, data = {}) {
  const entry = {
    id: 'AUD-' + Date.now() + '-' + Math.random().toString(36).substr(2, 4),
    timestamp: new Date().toISOString(),
    action,
    description,
    data,
    wallet: connectedWallet || 'anonymous',
    userAgent: navigator.userAgent.substr(0, 50)
  };
  
  auditLog.unshift(entry);
  
  // Keep last 1000 entries
  while (auditLog.length > 1000) auditLog.pop();
  
  // Store in localStorage
  localStorage.setItem('auditLog', JSON.stringify(auditLog.slice(0, 100)));
  
  console.log('[AUDIT]', action, description, data);
}

// Load audit log from localStorage
function loadAuditLog() {
  const saved = localStorage.getItem('auditLog');
  if (saved) {
    auditLog.push(...JSON.parse(saved));
  }
}

// Get audit log for display
function getAuditLog(limit = 50) {
  return auditLog.slice(0, limit);
}

// ============== INIT CONFIG ==============

function initConfig() {
  loadConfig();
  loadAuditLog();
  
  // Add event listeners for job checkboxes
  ['Relay', 'Image', 'Audio', 'Text', 'Video', 'Verify', 'Gpu', 'Jury'].forEach(type => {
    const el = document.getElementById('job' + type);
    if (el) {
      el.addEventListener('change', () => {
        agentConfig.jobs[type.toLowerCase()] = el.checked;
        saveConfig();
      });
    }
  });
  
  // Quota mode
  document.querySelectorAll('input[name="quotaMode"]').forEach(el => {
    el.addEventListener('change', () => {
      agentConfig.quotaMode = el.value;
      saveConfig();
    });
  });
  
  // Enable agent toggle if wallet connected
  if (connectedWallet) {
    const btn = document.getElementById('agentToggleBtn');
    btn.disabled = false;
    btn.style.opacity = '1';
    document.getElementById('agentStatusText').textContent = 'Ready to start';
  }
  
  logAudit('SESSION_START', 'War Room session started', { url: window.location.href });
}

// Extend init
const originalInit = init;
init = function() {
  originalInit();
  initConfig();
};

// Extend onConnected for config
const origOnConnected2 = onConnected;
onConnected = function(wallet) {
  origOnConnected2(wallet);
  
  const btn = document.getElementById('agentToggleBtn');
  btn.disabled = false;
  btn.style.opacity = '1';
  document.getElementById('agentStatusText').textContent = 'Ready to start';
  
  logAudit('WALLET_CONNECT', 'Wallet connected', { wallet: wallet.slice(0, 8) + '..' });
};

document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
